<!DOCTYPE html>
<html>
<head>
    <#include "head.ftl"/>
    <link href="/css/basic.css" rel="stylesheet">
    <link href="/css/jquery.steps.css" rel="stylesheet">
    <link href="/js/lib/fileinput/fileinput.min.css" rel="stylesheet">
    <link href="/css/accept.css" rel="stylesheet">
    <style type="text/css">
        .wizard > .content
        {
            background: #eeeeee30;
        }
    </style>
</head>
<body>
 <!-- 添加申请人信息 -->
    <div class="modal fade" id="saveSubjectModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">新增申请人信息</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal" id="subjectForm">
              <div class="form-group">
                <label for="mold" class="col-sm-3 control-label">权利人角色</label>
                <div class="col-sm-8">
                    <select class="form-control" id="mold" required="required"></select>
                </div>
              </div>
              <div class="form-group">
                <label for="name" class="col-sm-3 control-label">权利人名称</label>
                <div class="col-sm-8">
                  <input type="text" class="form-control" name="name" id="name" placeholder="权利人名称填写(必填)" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="certificateMold" class="col-sm-3 control-label">证件名称</label>
                <div class="col-sm-8">
                    <select class="form-control" id="certificateMold" required="required"></select>
                </div>
              </div>
              <div class="form-group">
                <label for="certificate" class="col-sm-3 control-label">证件号码</label>
                <div class="col-sm-8">
                  <input type="text" class="form-control" name="certificate" id="certificate" placeholder="请填写证件号码" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="phone" class="col-sm-3 control-label">联系方式</label>
                <div class="col-sm-8">
                  <input type="number" class="form-control" name="phone" id="phone" placeholder="" required="required" >
                </div>
              </div>
              
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="saveSubjectButton">插入列表</button>
          </div>
        </div>
      </div>
    </div>

  <!-- 添加房屋信息 -->
    <div class="modal fade" id="saveHouseModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">新增房屋信息</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal" id="houseForm">
              <div class="form-group">
                <label for="buildNo" class="col-sm-2 control-label">楼(幢)号</label>
                <div class="col-sm-3">
                  <input type="text" class="form-control" name="buildNo" id="buildNo" placeholder="楼号填写(必填)" required="required" >
                </div>
                <label for="buildArea" class="col-sm-3 control-label">建筑面积</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" name="buildArea" id="buildArea" placeholder="建筑面积" pattern="^[0-9]+([.]{1}[0-9]{1,2})?$" data-bv-regexp-message="请输入正确的面积" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="houseNo" class="col-sm-2 control-label">房号</label>
                <div class="col-sm-3">
                  <input type="text" class="form-control" name="houseNo" id="houseNo" placeholder="房号填写(必填)" required="required" >
                </div>
                <label for="innerArea" class="col-sm-3 control-label">套内建筑面积</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" name="innerArea" id="innerArea" placeholder="套内建筑面积" pattern="^[0-9]+([.]{1}[0-9]{1,2})?$" data-bv-regexp-message="请输入正确的面积" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="buildStructure" class="col-sm-2 control-label">建筑结构</label>
                <div class="col-sm-3">
                    <select class="form-control" id="buildStructure" required="required"></select>
                </div>
                <label for="shareArea" class="col-sm-3 control-label">分摊建筑面积</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" name="shareArea" id="shareArea" placeholder="分摊面积" pattern="^[0-9]+([.]{1}[0-9]{1,2})?$" data-bv-regexp-message="请输入正确的面积" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="layersTotal" class="col-sm-2 control-label">总层数</label>
                <div class="col-sm-3">
                  <input type="number" class="form-control" name="layersTotal" id="layersTotal" placeholder="总层数" required="required" >
                </div>
                <label for="layersLocation" class="col-sm-3 control-label">所在层</label>
                <div class="col-sm-4">
                  <input type="number" class="form-control" name="layersLocation" id="layersLocation" placeholder="层数" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="planUse" class="col-sm-2 control-label">房屋用途</label>
                <div class="col-sm-10">
                    <select class="form-control" id="planUse" required="required"></select>
                </div>
              </div>
              
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="saveHouserButton">插入列表</button>
          </div>
        </div>
      </div>
    </div>

<!-- 文件上传 -->
    <div class="modal fade" id="saveModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <input type="text" name="fileManageId" id="fileManageId" style="display: none;">
            <h4 class="modal-title">文件信息</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal" id="fileForm">
                <div class="form-group">
                    <label for="codefile" class="col-sm-2 control-label">文件上传</label>
                    <div class="col-sm-10">
                        <input type="hidden" name="configFile" id="configFile" placeholder="请上传.rar、.doc文件" required="required">
                        <a id="configFileDownload" hidden="hidden">下载</a>
                        <input id="input-configfile" type="file" name="file" multiple class="file-loading">
                    </div>
                </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
   <div class="ibox-content" id="baseinfo">
        <form id="form" action="#" class="wizard-big form-horizontal">
            <h1>权属基本信息</h1>
            <fieldset>
                <div class="form-group">
                    <label for="location" class="col-sm-3 control-label">房屋坐落</label>
                    <div class="col-sm-9">
                        <input name="location" type="text" class="form-control required">
                    </div>
                    <input name="id" id="id" style="display: none;" type="text" >
                </div>
                <div class="form-group">
                    <label for="originalLocation" class="col-sm-3 control-label">原房屋坐落</label>
                     <div class="col-sm-9">
                        <input name="originalLocation" type="text" class="form-control">
                     </div>
                </div>
                <div class="form-group">
                   <label for="certificate" class="col-sm-3 control-label">不动产权证号（原房产证号）</label>
                   <div class="col-sm-9">
                       <input name="certificate" type="text" class="form-control">
                   </div>
                </div>
            </fieldset>
            
            <h1>房屋状况</h1>
            <fieldset>
                 <div class="row">
                    <div class="form-group col-md-12">
                        <div class="bs-example" data-example-id="hoverable-table">
                        <table class="table table-hover" id="housetable">
                            <thead>
                            <tr>
                                <th>楼(幢)号</th>
                                <th>房号</th>
                                <th>建筑结构</th>
                                <th>总层数</th>
                                <th>所在层</th>
                                <th>建筑面积</th>
                                <th>套内建筑面积</th>
                                <th>分摊建筑面积</th>
                                <th>房屋规划</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody id="houses">
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </fieldset> 
            
            <h1>申请人情况</h1>
            <fieldset>
                 <div class="row">
                    <div class="form-group col-md-12">
                        <div class="bs-example" data-example-id="hoverable-table">
                        <table class="table table-hover" id="subjectable">
                            <thead>
                            <tr>
                                <th>权利人角色</th>
                                <th>权利人名称</th>
                                <th>证件名称</th>
                                <th>证件号码</th>
                                <th>联系方式</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody id="subjects">
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </fieldset> 
            
            <h1>附件列表</h1>
            <fieldset>
                 <div class="row">
                    <div class="form-group col-md-12">
                        <div class="bs-example" data-example-id="hoverable-table">
                        <table class="table table-hover" id="filestable">
                            <thead>
                            <tr>
                                <th>附件名称</th>
                                <th>上传类型</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="files">
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </fieldset>
        </form>
        <input type="text" style="display: none;" id="siffFileId">
    </div>
<#include "script.ftl"/>
<script src="/js/lib/fileinput/fileinput.min.js"></script>
<script src="/js/lib/fileinput/fileinput/zh.min.js"></script>
<script src="/js/jquery.steps.min.js"></script>
<script src="/js/jquery.validate.min.js"></script>
<script src="/js/message_cn.js"></script>
<script type="text/javascript">

$(document).ready(function(){
   var id = getParameterByName('applyid');
   var acceptance = getParameterByName('acceptance');
   
   if(acceptance){
       $('#baseinfo').find('input,textarea,select').attr('readOnly',true);
   }
   $('#id').val(id);
   var labelsInfo ;
   if(acceptance !== '2'){
       labelsInfo = {finish:"最后一页",next:"下一步",previous:"上一步",cancel:"取消"};
   }else{
       labelsInfo = {finish:"保存",next:"下一步",previous:"上一步",cancel:"取消"};
   }
   //labelsInfo = {finish:"保存",next:"下一步",previous:"上一步",cancel:"取消"};
   $("#form").steps({
        bodyTag: "fieldset",
        labels: labelsInfo,
        startIndex:3,
        onStepChanging: function (event, currentIndex, newIndex)
        {
            if (currentIndex > newIndex)
            {
                return true;
            }
            var form = $(this);

            if (currentIndex < newIndex)
            {
                $(".body:eq(" + newIndex + ") label.error", form).remove();
                $(".body:eq(" + newIndex + ") .error", form).removeClass("error");
            }

            form.validate().settings.ignore = ":disabled,:hidden";

            return form.valid();
        },
        onStepChanged: function (event, currentIndex, priorIndex)
        {
            if(id){
                if(currentIndex==0){
                    $("div.actions ul").prepend('<li class="download" aria-disabled="false"><a id="view">查看申请表</a></li>');
                    $("#view").on("click", function() {
                        $.ajax({ url:"/exprot/files/house/" + id , dataType:"html", success: function(data){
                            viewfile(data , "xls");
                        }});
                    })
                }else{
                    $("div.actions ul li.download").remove();
                }
                
                /* if(currentIndex==3){
                    $("div.actions ul").prepend('<li class="viewCAD" aria-disabled="false"><a  id="viewCAD">查看CAD图纸</a></li>');
                    $("#viewCAD").on("click", function() {
                        var sifFile = $("#siffFileId").val();
                        if(sifFile == "0"){
                            layer.alert("没有上传CAD图!")
                            return ;
                        }
                        
                        openCad(sifFile);
                    });
                }else{
                    $("div.actions ul li.viewCAD").remove();
                } */
            }
            
            if(acceptance){
                return ;
            }
            
            if(currentIndex==1){
                $("div.actions ul").prepend('<li class="addhouse" aria-disabled="false"><a  id="addhouse">新增户室</a></li>');
                $("#addhouse").on("click", function() {
                    resetForm("houseForm");
                    loadStype("house.buildStructure.type","buildStructure");
                    loadStype("house.planUse.type","planUse");
                    $('#saveHouseModal').modal('show');
                });
            }else{
                $("div.actions ul li.addhouse").remove();
            }
            
            if(currentIndex==2){
                $("div.actions ul").prepend('<li class="addsubject" aria-disabled="false"><a  id="addsubject">新增申请人</a></li>');
                $("#addsubject").on("click", function() {
                    resetForm("subjectForm");
                    loadStype("house.certificateMold.type","certificateMold");
                    loadStype("house.mold.type","mold");
                    $('#saveSubjectModal').modal('show');
                });
            }else{
                $("div.actions ul li.addsubject").remove();
            }
        },
        onFinishing: function (event, currentIndex)
        {
            
            var form = $(this);

            form.validate().settings.ignore = ":disabled";

            return form.valid();
        },
        onFinished: function (event, currentIndex)
        {
            if(acceptance !== '2'){
                layer.alert("当前已是最后一页! ", {icon: 1});
                return ;
            } 
            
            var txt=$('#form').serializeObject();
            var houseArray = [];
            var subjectArray = [];
            var fileArray = [];
            
            $('#houses').find('tr').each(function(i,v){
                var listHouse = {};
                listHouse.id = id;
                listHouse.buildNo = $(v).find("td:eq(0)").text();
                listHouse.houseNo = $(v).find("td:eq(1)").text();
                listHouse.buildStructure = $(v).find("td:eq(2)").text();
                listHouse.layersTotal = $(v).find("td:eq(3)").text();
                listHouse.layersLocation = $(v).find("td:eq(4)").text();
                listHouse.buildArea = $(v).find("td:eq(5)").text();
                listHouse.innerArea = $(v).find("td:eq(6)").text();
                listHouse.shareArea = $(v).find("td:eq(7)").text();
                listHouse.planUse = $(v).find("td:eq(8)").text();
                
                houseArray.push(listHouse);
             });
            
            $('#subjects').find('tr').each(function(i,v){
                var listSubject = {};
                listSubject.id = id;
                listSubject.mold = $(v).find("td:eq(0)").text();
                listSubject.name = $(v).find("td:eq(1)").text();
                listSubject.certificateMold = $(v).find("td:eq(2)").text();
                listSubject.certificate = $(v).find("td:eq(3)").text();
                listSubject.phone = $(v).find("td:eq(4)").text();
                
                subjectArray.push(listSubject);
            });
            
            $('#files').find('tr').each(function(i,v){
                var listFileType = {};
                
                if(isJSON($(v).find("td:eq(1)").text())){
                    var jsonFile = JSON.parse($(v).find("td:eq(1)").text());
                    
                    for(var i=0; i < jsonFile.length; i++){
                        var listFileType = {};
                    
                        listFileType.applyid = jsonFile[i].applyid;
                        listFileType.fileManageId = jsonFile[i].fileManageId;
                        listFileType.fileId = jsonFile[i].fileId;
                        
                        fileArray.push(listFileType);
                    }
                }else{
                    
                    if($(v).find("td:eq(1)").text() !== "undefined"){
                        listFileType.applyid = id;
                        listFileType.fileManageId = $(v).find("td:eq(0)").text();
                        listFileType.fileId = eval("("+$(v).find("td:eq(1)").text()+")");
                        fileArray.push(listFileType);
                    }
                }
            });
            
            txt.listHouse = houseArray;
            txt.listSubject = subjectArray;
            txt.listFileType = fileArray;
            
            $.ajax({
                type:"POST",
                url:'/manage/house',
                contentType:"application/json",
                data:JSON.stringify(txt),
                success: function(data){
                    var index=parent.layer.getFrameIndex(window.name);
                    layer.alert("保存成功!", {icon: 1, closeBtn: 0},
                        function () {
                            window.parent.location.reload();
                            parent.layer.close(index);
                        } 
                    );
                },
                error: function(e,xhr,opt){
                    layer.alert("保存失败! ", {icon: 2});
                }
            });
        },
        onInit:function(event, currentIndex, priorIndex){
            if(id){
                if(currentIndex==0){
                    $("div.actions ul").prepend('<li class="download" aria-disabled="false"><a id="view">查看申请表</a></li>');
                    $("#view").on("click", function() {
                        $.ajax({ url:"/exprot/files/house/" + id , dataType:"html", success: function(data){
                            viewfile(data , "xls");
                        }});
                    })
                }else{
                    $("div.actions ul li.download").remove();
                }
                
                /* if(currentIndex==3){
                    $("div.actions ul").prepend('<li class="viewCAD" aria-disabled="false"><a  id="viewCAD">查看CAD图纸</a></li>');
                    $("#viewCAD").on("click", function() {
                        var sifFile = $("#siffFileId").val();
                        if(sifFile == "0"){
                            layer.alert("没有上传CAD图!")
                            return ;
                        }
                        
                        openCad(sifFile);
                    });
                }else{
                    $("div.actions ul li.viewCAD").remove();
                } */
            }
        }
    }).validate({
        errorPlacement: function (error, element)
        {
            element.before(error); 
        }
    }); 
   
   $("#saveHouserButton").on("click", function() {
       var listHouse = {};
       listHouse.id = id;
       listHouse.buildNo = $("#buildNo").val();
       listHouse.houseNo = $("#houseNo").val();
       listHouse.buildStructure = $("#buildStructure").val();
       listHouse.layersTotal = $("#layersTotal").val();
       listHouse.layersLocation = $("#layersLocation").val();
       listHouse.buildArea =$("#buildArea").val();
       listHouse.innerArea = $("#innerArea").val();
       listHouse.shareArea = $("#shareArea").val();
       listHouse.planUse = $("#planUse").val();

       if (!isFormValid("houseForm")) {
           return;
       }
       
       var housetable = $("#houses");
       var rowData = listHouse;
       var row = "<tr id><td>" + rowData.buildNo +"</td>"
                   +"<td>" + rowData.houseNo + "</td><td>" + rowData.buildStructure + "</td>"
                   +"<td>" + rowData.layersTotal + "</td><td>" + rowData.layersLocation + "</td>"
                   +"<td>" + rowData.buildArea + "</td><td>" + rowData.innerArea + "</td>"
                   +"<td>" + rowData.shareArea + "</td>"
                   +"<td>" + rowData.planUse + "</td>"
                   +"<td><button type='button' class='btn btn-danger btn-xs deleteHouserButton'>删除</button></td>";
       housetable.append(row);
       
       $('#saveHouseModal').modal('hide');
   })
   
   $("#houses").on("click", ".deleteHouserButton", function() {
       $(this).parents('tr').remove();
   });
   
   $("#saveSubjectButton").on("click", function() {
       var listSubject = {};
       listSubject.id = id;
       listSubject.mold = $("#mold").val();
       listSubject.name = $("#name").val();
       listSubject.certificateMold = $("#certificateMold").val();
       listSubject.certificate = $("#certificate").val();
       listSubject.phone = $("#phone").val();

       if (!isFormValid("subjectForm")) {
           return;
       }
       
       var subjectable = $("#subjects");
       var rowData = listSubject;
       var row = "<tr id><td>" + rowData.mold +"</td>"
                   +"<td>" + rowData.name + "</td><td>" + rowData.certificateMold + "</td>"
                   +"<td>" + rowData.certificate + "</td>"
                   +"<td>" + rowData.phone + "</td>"
                   +"<td><button type='button' class='btn btn-danger btn-xs deleteSubjectButton'>删除</button></td>";
       subjectable.append(row);
       
       $('#saveSubjectModal').modal('hide');
   })
   
   $("#subjects").on("click", ".deleteSubjectButton", function() {
       $(this).parents('tr').remove();
   });
   
   var loadStype = function(configPrefix,table) {
       $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefix, success: function(data){
           var tables = $("#" + table + "");
           tables.empty();
           $.each(data,function(index,obj){
               var arr = obj.value;
               var strs= new Array();
               strs = arr.split(",");
               for(var i=0;i<strs.length ;i++){
                   var rowData = strs[i];
                   tables.append("<option value='"+rowData+"'>" + rowData + "</option>");
               }
           });
       }});
   };
});
</script>
<script>
var url = "/house";
var manageUrl = "/manage/house";
var id = getParameterByName('applyid');
var acceptance = getParameterByName('acceptance');
var taskId = getParameterByName('taskId');
var insertUrl;
$('#id').val(id);
var mapfile = {};
var load = function() {
    
    var key = "stockroom";
    $.ajax({ url:"/workFlow/filesByKey?key="+key, success: function(data){
        $.ajax({url: url + "/file/id?applyid=" + id,success: function(dataFile){
            var filestable = $("#files");
            filestable.empty();
            for (var i=0;i<data.length;i++)
            {
                var rowData = data[i];
                
                if(!rowData){
                    continue;
                }
                
                var files ;
                var siffFile;
                if(mapfile[rowData.id] == null){
                	files = dataFile[rowData.id];
                	siffFile = dataFile[rowData.id] === undefined?undefined:dataFile[rowData.id][0].fileId;
                }else{
                	files = mapfile[rowData.id];
                	siffFile = mapfile[rowData.id];
                }
                
                var filebutton = "";
                
                if(rowData.fileType === 'siff'){
                    var sifFile = files === undefined?"0":files[0].fileId ;
                    $("#siffFileId").val(sifFile);
                }
                
                if(rowData.fileType === 'jpg'){
                    if(jQuery.isArray(files)){
                        filebutton = files === undefined?"":"<button type='button' onclick='viewJpgFile(" + JSON.stringify(files) + "," + JSON.stringify(rowData.fileType) + ");' class='btn btn-info btn-xs viewButton'>预览</button>";
                    }else{
                        filebutton = files === undefined?"":"<button type='button' onclick='viewfile(\""+files + "\",\""+rowData.fileType+"\");' class='btn btn-info btn-xs viewButton'>预览</button>";
                    }
                }else if(rowData.fileType === 'siff'){
               	 	var btnfile = "<button type='button' onclick='openCad(\""+siffFile + "\");' class='btn btn-info btn-xs'>预览</button>";
            	 	btnfile += "<button type='button' onclick='downloadCad(\""+siffFile + "\");' class='btn btn-danger btn-xs'>下载</button>";
            	 	filebutton = files === undefined?"": btnfile;
             	}else{
                    filebutton = files === undefined?"":"<button type='button' onclick='viewfile(\""+files[0].fileId + "\",\""+rowData.fileType+"\");' class='btn btn-info btn-xs viewButton'>预览</button>";
                }
                
                if(rowData.fileName.indexOf("具结书") >= 0 && acceptance == '2') { 
                    filebutton += "<button type='button' class='btn btn-warning btn-xs loadButton'>上传</button>";
                } 
                
                var row = "<tr><td hidden=>" + rowData.id +"</td><td hidden=>" + JSON.stringify(files) + "</td>"
                        + "<td style='text-align: left;'>" + rowData.fileName + "</td><td>" + rowData.fileType + "</td>"
                    row += "<td>" + filebutton + "</td></tr>";
                filestable.append(row);
            }
        }});
        
        $("#files ").on("click", ".loadButton", function() {
            var fileManageId = $(this).parents('tr').children().first().text();
            var allowedFileExtensions = $(this).parents('tr').children().first().next().next().next().text();
            $("#input-configfile").fileinput('destroy');
            
            (function (fileInputId, fileField, validate) {
               $("#" + fileInputId).fileinput({
                   language: 'zh', //设置语言
                   allowedFileExtensions: [allowedFileExtensions],//接收的文件后缀
                   msgInvalidFileExtension: '不正确的文件扩展名 "{name}". 只支持 "{extensions}"格式的文件.',
                   msgValidationError: '类型不正确',
                   elErrorContainer: '#kartik-file-errors',
                   showPreview : false, //显示预览 
                   showUpload: false,
                   showRemove:true,
                   maxFileCount: 1,
                   autoReplace:false,
                   uploadUrl: '/files'
               }).on("filebatchselected", function(event, files) {
                   $(this).fileinput("upload");
               }).on('filecleared', function(event) {
                   $("#" + fileField).val("");
                   $("#" + fileField + "Download").hide();
               }).on("fileuploaded", function(event, data) {
                   if(data.response) {
                       mapfile[fileManageId] = data.response.id;
                       $("#" + fileField).val(data.response.id);
                       $("#" + fileField + "Download").hide();
                       $('#saveModal').modal('hide');
                       load();
               }});
           })("input-configfile", "configFile");
       
           resetForm("fileForm");
           $('#saveModal').modal('show');
           $('input[name=fileManageId]').val(fileManageId)
        });
        
    }});

    
    if(id){
         $.ajax({ url: url+"/selectByHouseid?id="+encodeURI(id), success: function(obj){
            $('input[name=id]').val(obj.id)
            $('input[name=location]').val(obj.location)
            $('input[name=originalLocation]').val(obj.originalLocation)
            $('input[name=certificate]').val(obj.certificate)
            
            var housetable = $("#houses");
            housetable.empty();
            for (var i=0;i<obj.listHouse.length;i++)
            {
                var rowData = obj.listHouse[i];
                var deletebutton = "";
                if(!acceptance){
                    deletebutton += "<button type='button' class='btn btn-danger btn-xs deleteHouserButton'>删除</button>";
                }
                var row = "<tr id><td>" + rowData.buildNo +"</td>"
                            +"<td>" + rowData.houseNo + "</td><td>" + rowData.buildStructure + "</td>"
                            +"<td>" + rowData.layersTotal + "</td><td>" + rowData.layersLocation + "</td>"
                            +"<td>" + rowData.buildArea + "</td><td>" + rowData.innerArea + "</td>"
                            +"<td>" + rowData.shareArea + "</td>"
                            +"<td>" + rowData.planUse + "</td>"
                            +"<td>" + deletebutton + "</td>";
                housetable.append(row);
            }
            var subjectable = $("#subjects");
            subjectable.empty();
            for (var i=0;i<obj.listSubject.length;i++)
            {
                var rowData = obj.listSubject[i];
                var deletebutton = "";
                if(!acceptance){
                    deletebutton += "<button type='button' class='btn btn-danger btn-xs deleteSubjectButton'>删除</button>";
                }
                var row = "<tr id><td>" + rowData.mold +"</td>"
                            +"<td>" + rowData.name + "</td><td>" + rowData.certificateMold + "</td>"
                            +"<td>" + rowData.certificate + "</td>"
                            +"<td>" + rowData.phone + "</td>"
                            +"<td>" + deletebutton + "</td>";
                subjectable.append(row);
            }
        }}); 
    }
    
};

function viewfile(fileId,fileType) {
    var configPrefixFileUrl = "house.file.url";
    var configPrefixServer = "house.file.serverurl";
    
    /* if(fileType == "sidb"){
        openCad(fileId);
        return;
    }
    
    if(fileType == "siff"){
        openCad(fileId)
        return;
    } */
    
    $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixServer, success: function(service){
        $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixFileUrl, success: function(downfile){
            var file = "http://" + downfile[0].value + "/open/files/"+fileId;
            var url = "http://" + service[0].value + "/onlinePreview?url=" + encodeURIComponent(file) + "&fileType=" + fileType;
            var winHeight = window.document.documentElement.clientHeight-10;
            window.open(url, "_blank", "height=" + winHeight
                    + ",top=80,left=80,toolbar=no, menubar=no, scrollbars=yes, resizable=yes"); 
        }});
    }});
}

function viewJpgFile(fileIds, fileType) {
    var configPrefixFileUrl = "house.file.url";
    var configPrefixServer = "house.file.serverurl";
    
    $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixServer, success: function(service){
        $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixFileUrl, success: function(downfile){
            var urls = '';
            $.each(fileIds, function(index, value){
                if(index === fileIds.length - 1){
                    urls += "http://" + downfile[0].value + "/open/files/" + value['fileId'];
                    
                    return true;
                }
                urls += "http://" + downfile[0].value + "/open/files/" + value['fileId'] + "|";
            });
            
            var url = "http://" + service[0].value + "/picturesPreview?urls=" + encodeURIComponent(urls) + "&currentUrl=http://localhost:9080";
            var winHeight = window.document.documentElement.clientHeight-10;
            window.open(url, "_blank", "height=" + winHeight
                    + ",top=80,left=80,toolbar=no, menubar=no, scrollbars=yes, resizable=yes"); 
        }});
    }});
}

function isJSON(str) {
    if (typeof str == 'string') {
        try {
            var obj=JSON.parse(str);
            if(typeof obj == 'object' && obj ){
                return true;
            }else{
                return false;
            }

        } catch(e) {
            return false;
        }
    }
}

function openCad(fileId){
    layer.open({
      type: 2, //Layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）,
      shade:0.1, //遮罩层透明度
      area:['100%','100%'], //弹出层宽高
      title:'CAD图查看',//弹出层标题
      content: ['storckroom_cad.html?fileid='+fileId, 'no']
    });
}

function downloadCad(fileId){
	if(fileId){
		self.location.href="/open/files/"+fileId;
	}
}

load();
</script>
</body>
</html>