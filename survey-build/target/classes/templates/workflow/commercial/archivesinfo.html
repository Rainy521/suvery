<!DOCTYPE html>
<html>
<head>
    <#include "head.ftl"/>
    <link href="/css/basic.css" rel="stylesheet">
    <link href="/css/jquery.steps.css" rel="stylesheet">
    <link href="/js/lib/fileinput/fileinput.min.css" rel="stylesheet">
    <link href="/css/accept.css" rel="stylesheet">
    <style type="text/css">
        .wizard > .content
        {
            background: #eeeeee30;
        }
    </style>
</head>
<body>

  <!-- 添加房屋信息 -->
     <div class="modal fade" id="saveBuildingModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">新增幢户信息</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal" id="buildingForm">
              <div class="form-group">
                  <label for="lpzh" class="col-sm-2 control-label">楼盘幢号</label>
                  <div class="col-sm-4">
                      <input type="text" class="form-control" name="lpzh" id="lpzh" placeholder="楼盘幢号(必填)" required="required" >
                      <input type="text" class="form-control" id="projectNo" style="display: none;" >
                  </div>
                  
                  <label for="lpmc" class="col-sm-2 control-label">楼盘名称</label>
                  <div class="col-sm-4">
                      <input type="text" class="form-control" name="lpmc" id="lpmc" placeholder="楼盘名称(必填)" required="required" >
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="ghyt" class="col-sm-2 control-label">规划用途</label>
                  <div class="col-sm-4">
                      <select class="form-control" id="ghyt" required="required"></select>
                  </div>
                  
                  <label for="fwlx" class="col-sm-2 control-label">房屋类型</label>
                  <div class="col-sm-4">
                      <select class="form-control" id="fwlx" required="required"></select>
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="jznd" class="col-sm-2 control-label">建筑年代</label>
                  <div class="col-sm-4">
                      <input type="number" class="form-control" name="jznd" id="jznd" placeholder="建筑年代(必填)" >
                  </div>
                  
                  <label for="jzzmj" class="col-sm-2 control-label">总面积</label>
                  <div class="col-sm-4">
                      <input type="text" class="form-control" name="jzzmj" id="jzzmj" placeholder="建筑总面积(必填)" pattern="^[0-9]+([.]{1}[0-9]{1,2})?$" data-bv-regexp-message="请输入正确的面积"  required="required" >
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="zts" class="col-sm-2 control-label">总套数</label>
                  <div class="col-sm-4">
                      <input type="number" class="form-control" max="99999" name="zts" id="zts" placeholder="总套数(必填)" required="required" >
                  </div>
                  
                  <label for="zcs" class="col-sm-2 control-label">总层数</label>
                  <div class="col-sm-4">
                      <input type="number" class="form-control" max="999" name="zcs" id="zcs" placeholder="总层数(必填)" required="required" >
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="dscs" class="col-sm-2 control-label">地上层数</label>
                  <div class="col-sm-4">
                      <input type="number" class="form-control" max="99" name="dscs" id="dscs" placeholder="地上层数(必填)" required="required" >
                  </div>
                  
                  <label for="dxcs" class="col-sm-2 control-label">地下层数</label>
                  <div class="col-sm-4">
                      <input type="number" class="form-control" max="99" name="dxcs" id="dxcs" placeholder="地下层数(必填)" required="required" >
                  </div>
              </div>
              
              <div class="form-group">
                <label for="chlx" class="col-sm-2 control-label">测绘类型</label>
                <div class="col-sm-10">
                  <select class="form-control" id="chlx" required="required"></select>
                </div>
              </div>
              
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="saveBuildingButton">插入列表</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 添加房屋信息 -->
    <div class="modal fade" id="saveHouseModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">新增房屋信息</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal" id="houseForm">
              <div class="form-group">
                <label for="buildNo" class="col-sm-2 control-label">楼(幢)号</label>
                <div class="col-sm-3">
                  <select class="form-control" id="buildNo" required="required"></select>
                </div>
                <label for="buildArea" class="col-sm-3 control-label">建筑面积</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" name="buildArea" id="buildArea" placeholder="建筑面积" pattern="^[0-9]+([.]{1}[0-9]{1,2})?$" data-bv-regexp-message="请输入正确的面积" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="houseNo" class="col-sm-2 control-label">房号</label>
                <div class="col-sm-3">
                  <input type="text" class="form-control" name="houseNo" id="houseNo" placeholder="房号填写(必填)" required="required" >
                </div>
                <label for="innerArea" class="col-sm-3 control-label">套内建筑面积</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" name="innerArea" id="innerArea" placeholder="套内建筑面积" pattern="^[0-9]+([.]{1}[0-9]{1,2})?$" data-bv-regexp-message="请输入正确的面积" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="buildStructure" class="col-sm-2 control-label">建筑结构</label>
                <div class="col-sm-3">
                    <select class="form-control" id="buildStructure" required="required"></select>
                </div>
                <label for="shareArea" class="col-sm-3 control-label">分摊建筑面积</label>
                <div class="col-sm-4">
                  <input type="text" class="form-control" name="shareArea" id="shareArea" placeholder="分摊面积" pattern="^[0-9]+([.]{1}[0-9]{1,2})?$" data-bv-regexp-message="请输入正确的面积" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="layersTotal" class="col-sm-2 control-label">总层数</label>
                <div class="col-sm-3">
                  <input type="number" class="form-control" name="layersTotal" id="layersTotal" placeholder="总层数" required="required" >
                </div>
                <label for="layersLocation" class="col-sm-3 control-label">所在层</label>
                <div class="col-sm-4">
                  <input type="number" class="form-control" name="layersLocation" id="layersLocation" placeholder="层数" required="required" >
                </div>
              </div>
              <div class="form-group">
                <label for="planUse" class="col-sm-2 control-label">房屋用途</label>
                <div class="col-sm-10">
                    <select class="form-control" id="planUse" required="required"></select>
                </div>
              </div>
              
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="saveHouserButton">插入列表</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 文件上传 -->
    <div class="modal fade" id="saveModal">
        <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <input type="text" name="fileManageId" id="fileManageId" style="display: none;">
            <h4 class="modal-title">文件信息</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal" id="fileForm">
                <div class="form-group">
                    <label for="codefile" class="col-sm-2 control-label">文件上传</label>
                    <div class="col-sm-10">
                        <input type="hidden" name="configFile" id="configFile" placeholder="请上传.rar、.doc文件" required="required">
                        <a id="configFileDownload" hidden="hidden">下载</a>
                        <input id="input-configfile" type="file" name="file" multiple class="file-loading">
                    </div>
                </div>
            </form>
          </div>
        </div>
        </div>
    </div>
    
    <div class="modal fade" id="archivesModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">档案管理</h4>
          </div>
          <div class="modal-body">
            <div class="row">
                <div class="col-md-12">
                <div id="archivesTable"></div>
            </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="saveArchivesButton">保存</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="ibox-content" id="baseinfo">
        <form id="form" action="#" class="wizard-big form-horizontal">
            <h1>项目基本信息</h1>
            <fieldset>
                <div class="form-group" style="display: none;">
                    <label for="cname" class="col-sm-3 control-label">项目编号</label>
                    <div class="col-sm-8">
                        <input style="width:87%;display:inline-block;" name="projectNo" type="text" class="form-control required">
                        
                        <button type='button' id="xmbhsh" class='btn btn-info deleteUserButton' style="width:12%;vertical-align:baseline;background:#1AB394;">生成编号</button>
                    </div>
                    <input name="id" id="id" style="display: none;" type="text" >
                </div>
                <div class="form-group">
                    <label for="contacts" class="col-sm-3 control-label">项目名称</label>
                     <div class="col-sm-8">
                        <input name="projectName" type="text" class="form-control required">
                     </div>
                </div>
                <div class="form-group">
                    <label for="phone" class="col-sm-3 control-label">项目类型</label>
                     <div class="col-sm-8">
                        <select class="form-control" name="projectType" id="projectType"></select>
                     </div>
                </div>
                <div class="form-group">
                   
                </div>
                <div class="form-group">
                   <label for="certificate" class="col-sm-3 control-label">建设单位</label>
                   <div class="col-sm-3">
                       <input name="projectFzr" type="text" class="form-control required">
                   </div>
                   
                   <label for="certificate" class="col-sm-2 control-label">项目坐落</label>
                   <div class="col-sm-3">
                       <input name="projectXmzl" type="text" class="form-control required">
                   </div>
                </div>
                
                <div class="form-group">
                    <label for="lxdh" class="col-sm-3 control-label">联系人</label>
                     <div class="col-sm-3">
                        <input name="lxr" type="text" class="form-control">
                     </div>
                     <label for="lxdh" class="col-sm-2 control-label">联系电话</label>
                     <div class="col-sm-3">
                        <input name="lxdh" type="text" class="form-control">
                     </div>
                </div>
                <div class="form-group">
                    <label for="expiryTime" class="col-sm-3 control-label">项目概况</label>
                     <div class="col-sm-8">
                        <input name="projectGk" type="text" class="form-control">
                     </div>
                </div>
            </fieldset>
            
            <h1>添加幢户信息</h1>
            <fieldset>
                 <div class="row">
                    <div class="form-group col-md-12">
                        <div class="bs-example" data-example-id="hoverable-table">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>项目编号</th>
                                <th>楼盘幢号</th>
                                <th>楼盘坐落</th>
                                <th>规划用途</th>
                                <th hidden=>房屋类型</th>
                                <th>建筑年代</th>
                                <th hidden=>外围总面积</th>
                                <th hidden=>户室总面积</th>
                                <th>建筑总面积</th>
                                <th>总套数</th>
                                <th>总层数</th>
                                <th>地上层数</th>
                                <th>地下层数</th>
                                <th>测绘类型</th>
                                <th>建筑结构</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody id="buildings">
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </fieldset> 
            
           <!-- <h1>房屋状况</h1>
           <fieldset>
                <div class="row">
                    <div id="div1"></div>
                </div>
           </fieldset>  -->
           
           <h1>附件列表</h1>
           <fieldset>
                <div class="row">
                   <div class="form-group col-md-12">
                       <div class="bs-example" data-example-id="hoverable-table">
                       <table class="table table-hover" id="filestable">
                           <thead>
                           <tr>
                               <th>附件名称</th>
                               <th>上传类型</th>
                               <th>操作</th>
                           </tr>
                           </thead>
                           <tbody id="files">
                           </tbody>
                       </table>
                       </div>
                   </div>
               </div>
           </fieldset>
        </form>
    </div>
<#include "script.ftl"/>
<script src="/js/lib/fileinput/fileinput.min.js"></script>
<script src="/js/lib/fileinput/fileinput/zh.min.js"></script>
<script src="/js/jquery.steps.min.js"></script>
<script src="/js/jquery.validate.min.js"></script>
<script src="/js/lib/treegrid/treegrid.js"></script>
<script src="/js/message_cn.js"></script>
<script type="text/javascript">

$(document).ready(function(){
   initMesage();
   var id = getParameterByName('applyid');
   var acceptance = getParameterByName('acceptance');
   
   if(acceptance){
       $('#baseinfo').find('input,textarea,select').attr('readOnly',true);
   }
   $('#id').val(id);
   var labelsInfo ;
   if(acceptance !== '2'){
       labelsInfo = {finish:"最后一页",next:"下一步",previous:"上一步",cancel:"取消"};
   }else{
       labelsInfo = {finish:"保存",next:"下一步",previous:"上一步",cancel:"取消"};
   }
   $("#form").steps({
        bodyTag: "fieldset",
        labels: labelsInfo,
        startIndex:2,
        onStepChanging: function (event, currentIndex, newIndex)
        {
            if (currentIndex > newIndex)
            {
                return true;
            }
            var form = $(this);

            if (currentIndex < newIndex)
            {
                $(".body:eq(" + newIndex + ") label.error", form).remove();
                $(".body:eq(" + newIndex + ") .error", form).removeClass("error");
            }

            form.validate().settings.ignore = ":disabled,:hidden";

            return form.valid();
        },
        onStepChanged: function (event, currentIndex, priorIndex)
        {
            /* if(currentIndex==3){
                $("div.actions ul").prepend('<li class="download" aria-disabled="false"><a id="view">查看汇总表</a></li>');
                $("#view").on("click", function() {
                    $.ajax({ url:"/exprot/files/commercial/view/summary/" + id , dataType:"html", success: function(data){
                        viewfile(data , "xls");
                    }});
                })
                
                $("div.actions ul").prepend('<li class="viewFloorSpace" aria-disabled="false"><a id="viewfloorSpace">查看房屋面积审核表</a></li>');
                    $("#viewfloorSpace").on("click", function() {
                        $.ajax({ url:"/exprot/files/commercial/view/floorSpace/" + id , dataType:"html", success: function(data){
                            viewfile(data , "xls");
                    }});
                })
                
                $("div.actions ul").prepend('<li class="viewdetails" aria-disabled="false"><a id="viewdetails">查看分户明细表</a></li>');
                    $("#viewdetails").on("click", function() {
                        $.ajax({ url:"/exprot/files/commercial/view/details/" + id , dataType:"html", success: function(data){
                            viewfile(data , "xls");
                    }});
                })
            }else{
                $("div.actions ul li.download").remove();
                $("div.actions ul li.viewFloorSpace").remove();
                $("div.actions ul li.viewdetails").remove();
            } */
            
            if(acceptance){
                return ;
            }
            
           if(currentIndex==1){
                $("div.actions ul").prepend('<li class="adduser" aria-disabled="false"><a  id="addBuilding">新增幢户</a></li>');
                $("#addBuilding").on("click", function() {
                    resetForm("buildingForm");
                    loadStype("commodity.house.fwlx","fwlx");
                    loadStype("commodity.house.chlx","chlx");
                    loadStype("house.planUse.type","ghyt");
                    $("#projectNo").val($('input[name=projectNo]').val());
                    $('#saveBuildingModal').modal('show');
                });
            }else{
                $("div.actions ul li.adduser").remove();
            }
           
           if(currentIndex==2){
               $("div.actions ul").prepend('<li class="addhouse" aria-disabled="false"><a  id="addhouse">新增户室</a></li>');
               $("#addhouse").on("click", function() {
                   resetForm("houseForm");
                   loadStype("house.buildStructure.type","buildStructure");
                   loadStype("house.planUse.type","planUse");
                   loadBuildNos("buildNo");
                   $('#saveHouseModal').modal('show');
               });
           }else{
               $("div.actions ul li.addhouse").remove();
           }
           
        },
        onFinishing: function (event, currentIndex)
        {
            
            var form = $(this);

            form.validate().settings.ignore = ":disabled";

            return form.valid();
        },
        onFinished: function (event, currentIndex)
        {
            if(acceptance != '2'){
                layer.alert("当前已是最后一页! ", {icon: 1});
                return ;
            }
            
            var txt=$('#form').serializeObject();
            
            var listMemberArray = [];
            var houseArray = [];
            var fileArray = [];
            
            $('#buildings').find('tr').each(function(i,v){
                var listMember = {};
                listMember.applyId = id;
                listMember.projectNo = $(v).find("td:eq(1)").text();
                listMember.lpzh = $(v).find("td:eq(2)").text();
                listMember.lpmc = $(v).find("td:eq(3)").text();
                listMember.ghyt = $(v).find("td:eq(4)").text();
                listMember.fwlx = $(v).find("td:eq(5)").text();
                listMember.jznd = $(v).find("td:eq(6)").text();
                listMember.wwjzmj = $(v).find("td:eq(7)").text();
                listMember.hsjzmj = $(v).find("td:eq(8)").text();
                listMember.jzzmj = $(v).find("td:eq(9)").text();
                listMember.zts = $(v).find("td:eq(10)").text();
                listMember.zcs = $(v).find("td:eq(11)").text();
                listMember.dscs = $(v).find("td:eq(12)").text();
                listMember.dxcs = $(v).find("td:eq(13)").text();
                listMember.chlx = $(v).find("td:eq(14)").text();
                listMember.jzjg = $(v).find("td:eq(15)").text();
                
                listMemberArray.push(listMember);
             });
            
            txt.listBuilding = listMemberArray;
            
            $('#houses').find('tr').each(function(i,v){
                var listHouse = {};
                listHouse.id = id;
                listHouse.buildNo = $(v).find("td:eq(0)").text();
                listHouse.lpzh = $(v).find("td:eq(1)").text();
                listHouse.houseNo = $(v).find("td:eq(2)").text();
                listHouse.buildStructure = $(v).find("td:eq(3)").text();
                listHouse.layersTotal = $(v).find("td:eq(4)").text();
                listHouse.layersLocation = $(v).find("td:eq(5)").text();
                listHouse.buildArea = $(v).find("td:eq(6)").text();
                listHouse.innerArea = $(v).find("td:eq(7)").text();
                listHouse.shareArea = $(v).find("td:eq(8)").text();
                listHouse.planUse = $(v).find("td:eq(9)").text();
                
                houseArray.push(listHouse);
             });
            txt.listHouse = houseArray;
            
            $('#files').find('tr').each(function(i,v){
                var listFileType = {};
                
                if(isJSON($(v).find("td:eq(1)").text())){
                    var jsonFile = JSON.parse($(v).find("td:eq(1)").text());
                    
                    for(var i=0; i < jsonFile.length; i++){
                        var listFileType = {};
                    
                        listFileType.applyid = jsonFile[i].applyid;
                        listFileType.fileManageId = jsonFile[i].fileManageId;
                        listFileType.fileId = jsonFile[i].fileId;
                        
                        fileArray.push(listFileType);
                    }
                }else{
                    
                    if($(v).find("td:eq(1)").text() !== "undefined"){
                        listFileType.applyid = id;
                        listFileType.fileManageId = $(v).find("td:eq(0)").text();
                        listFileType.fileId = eval("("+$(v).find("td:eq(1)").text()+")");
                        fileArray.push(listFileType);
                    }
                }
             });
            txt.listFiles = fileArray;
            
            $.ajax({
                type:"POST",
                url:'/manage/commodityHouse',
                contentType:"application/json",
                data:JSON.stringify(txt),
                success: function(data){
                    var index=parent.layer.getFrameIndex(window.name);
                    layer.alert("保存成功!", {icon: 1, closeBtn: 0},
                        function () {
                            window.parent.location.reload();
                            parent.layer.close(index);
                        } 
                    );
                },
                error: function(e,xhr,opt){
                    layer.alert("保存失败! ", {icon: 2});
                }
            });
            
        },
        onInit:function(event, currentIndex, priorIndex){
            if(id){
                if(currentIndex==2){
                   /*  $("div.actions ul").prepend('<li class="download" aria-disabled="false"><a id="view">查看汇总表</a></li>');
                    $("#view").on("click", function() {
                        $.ajax({ url:"/exprot/files/commercial/view/summary/" + id , dataType:"html", success: function(data){
                            viewfile(data , "xls");
                        }});
                    })
                    
                    $("div.actions ul").prepend('<li class="viewFloorSpace" aria-disabled="false"><a id="viewfloorSpace">查看房屋面积审核表</a></li>');
                        $("#viewfloorSpace").on("click", function() {
                            $.ajax({ url:"/exprot/files/commercial/view/floorSpace/" + id , dataType:"html", success: function(data){
                                viewfile(data , "xls");
                        }});
                    })
                    
                    $("div.actions ul").prepend('<li class="viewdetails" aria-disabled="false"><a id="viewdetails">查看分户明细表</a></li>');
                        $("#viewdetails").on("click", function() {
                            $.ajax({ url:"/exprot/files/commercial/view/details/" + id , dataType:"html", success: function(data){
                                viewfile(data , "xls");
                        }});
                    }) */
                    
                    $("div.actions ul").prepend('<li class="archives" aria-disabled="false"><a id="archives">归档</a></li>');
                        $("#archives").on("click", function() {
                            loadMenu();
                            $('#archivesModal').modal('show');
                    })
                }else{
                    $("div.actions ul li.download").remove();
                    $("div.actions ul li.viewFloorSpace").remove();
                    $("div.actions ul li.viewdetails").remove();
                }
            }
        }
    }).validate({
        errorPlacement: function (error, element)
        {
            element.before(error); 
        }
    }); 
   
});

$("#saveArchivesButton").on("click", function() {
    
    var data = {};
    var con = true;
    var num = 0;
    
    $('input:checkbox[name=menu]:checked').each(function(i){
        var row = $(this).parent().parent().attr('data');
        row = eval("("+row+")");
        data.name = row.name;
        data.id = row.id;
        data.casenumber = row.casenumber + ',commercial-' + id;
        if(row.next == 0){
            con = false;
        }
        
        if(num > 0){
            layer.alert('请选择一个档案盒保存！');
        }
        
        num++;
    });
    
    if(!con){
        layer.alert('请选择档案盒保存！');
        return;
    } 
    
    $.ajax({ url:"/archives/flagArchive?id=" + 'commercial-' + id, success: function(flag){
        if(flag){
            layer.alert('档案已经存过！');
            return;
        } 
        
        $.ajax({ 
            type:"POST",
            url: "/manage/archives/update",
            contentType:"application/json",
            data:JSON.stringify(data),
            success: function(data){
                         layer.alert("保存成功!", {icon: 1, time : 1500});
                         $('#archivesModal').modal('hide');
                     },
            error: function(e,xhr,opt){
                layer.alert("保存失败! " + e.responseJSON.message, {icon: 2});
            }
        });
    }})
    
})

function customCheckBox(row, col){
    return "<input name='menu' type='checkbox'>";
}

function itemClickEvent(id, index, data){
    jQuery("#currentRow").val(id + ", " + index + ", " + TreeGrid.json2str(data));
}

function expandAll(isOpen){
    treeGrid.expandAll(isOpen);
}

function loadMenu(){
    $.get("/archives/viewShow").done(function (data) {
        var config = {
            id: "tg1",
            width: "800",
            renderTo: "archivesTable",
            headerAlign: "left",
            headerHeight: "30",
            dataAlign: "left",
            indentation: "40",
            folderColumnIndex: "1",
            folderOpenIcon: "/img/folderOpen.gif",
            folderCloseIcon: "/img/folderClose.gif",
            defaultLeafIcon: "/img/defaultLeaf.gif",
            itemClick: "itemClickEvent",
            doubleClick: "",
            expandLayer: 3,
            columns:[
                {headerText: "", headerAlign: "center", handler: "customCheckBox", dataAlign: "center", width: "20"},
                {headerText: "档案名称", dataField: "name", headerAlign: "center"},
            ],
            data:data
        };
      //创建一个组件对象  
        var treeGrid1 = new TreeGrid(config);
        treeGrid1.show();
        
    });
}
</script>
<script>
var url = "/commodityHouse";
var manageUrl = "/manage/commodityHouse";
var id = getParameterByName('applyid');
var acceptance = getParameterByName('acceptance');
var taskId = getParameterByName('taskId');
$('#id').val(id);
var mapfile = {};
var load = function() {

    var key = "commercial";
    $.ajax({ url:"/workFlow/filesByKey?key="+key, success: function(data){
        $.ajax({url:"/house/file/id?applyid=" + id,success: function(dataFile){
            var filestable = $("#files");
            filestable.empty();
            for (var i=0;i<data.length;i++)
            {
                var rowData = data[i];
                
                if(!rowData){
                    continue;
                }
                
                var files ;
                var siffFile;
                if(mapfile[rowData.id] == null){
                	files = dataFile[rowData.id];
                	siffFile = dataFile[rowData.id] === undefined?undefined:dataFile[rowData.id][0].fileId;
                }else{
                	files = mapfile[rowData.id];
                	siffFile = mapfile[rowData.id];
                }
                
                var filebutton = "";
                
                if(rowData.fileType === 'jpg'){
                    if(jQuery.isArray(files)){
                        filebutton = files === undefined?"":"<button type='button' onclick='viewJpgFile(" + JSON.stringify(files) + "," + JSON.stringify(rowData.fileType) + ");' class='btn btn-info btn-xs viewButton'>预览</button>";
                    }else{
                        filebutton = files === undefined?"":"<button type='button' onclick='viewfile(\""+files + "\",\""+rowData.fileType+"\");' class='btn btn-info btn-xs viewButton'>预览</button>";
                    }
                 }else if(rowData.fileType === 'siff'){
                	 var btnfile = "<button type='button' onclick='openCad(\""+siffFile + "\");' class='btn btn-info btn-xs'>预览</button>";
                	 btnfile += "<button type='button' onclick='downloadCad(\""+siffFile + "\");' class='btn btn-danger btn-xs'>下载</button>";
                	 filebutton = files === undefined?"": btnfile;
                 }else{
                    filebutton = files === undefined?"":"<button type='button' onclick='viewfile(\""+files[0].fileId + "\",\""+rowData.fileType+"\");' class='btn btn-info btn-xs viewButton'>预览</button>";
               	 }
                
                if(rowData.fileName.indexOf("具结书") >= 0 && acceptance == '2') { 
                    filebutton += "<button type='button' class='btn btn-warning btn-xs loadButton'>上传</button>";
                } 
               
                var row = "<tr><td hidden=>" + rowData.id +"</td><td hidden=>" + JSON.stringify(files) + "</td>"
                        + "<td style='text-align: left;'>" + rowData.fileName + "</td><td>" + rowData.fileType + "</td>"
                    row += "<td>" + filebutton + "</td>"
                        + "</tr>";
                filestable.append(row);
            }
        }});
        
        $("#files ").on("click", ".loadButton", function() {
            var fileManageId = $(this).parents('tr').children().first().text();
            var allowedFileExtensions = $(this).parents('tr').children().first().next().next().next().text();
            
            var fileInput = $('<form class="form-horizontal" id="fileForm">'
                    + '<div class="form-group">'
                    + '<label for="codefile" class="col-sm-2 control-label">文件上传</label>'
                    + '<div class="col-sm-10">'
                    + '<input type="hidden" name="configFile" id="configFile" placeholder="请上传.rar、.doc文件" required="required">'
                    + '<a id="configFileDownload" hidden="hidden">下载</a>'
                    + '<input id="input-configfile" type="file" name="file" multiple class="file-loading">'
                    + '</div>'
                    + '</div>'
                    + '</form>');
            
            var content = $('#saveModal .modal-body');
            content.empty();
            content.append(fileInput);
            
            (function (fileInputId, fileField, validate) {
               $("#" + fileInputId).fileinput({
                   language: 'zh', //设置语言
                   allowedFileExtensions: [allowedFileExtensions],//接收的文件后缀
                   msgInvalidFileExtension: '不正确的文件扩展名 "{name}". 只支持 "{extensions}"格式的文件.',
                   msgValidationError: '类型不正确',
                   elErrorContainer: '#kartik-file-errors',
                   showPreview : false, //显示预览 
                   showUpload: false,
                   showRemove:true,
                   maxFileCount: 1,
                   autoReplace:false,
                   uploadUrl: '/files'
               }).on("filebatchselected", function(event, files) {
                   $(this).fileinput("upload");
               }).on('filecleared', function(event) {
                   $("#" + fileField).val("");
                   $("#" + fileField + "Download").hide();
               }).on("fileuploaded", function(event, data) {
                   if(data.response) {
                       mapfile[fileManageId] = data.response.id;
                       $("#" + fileField).val(data.response.id);
                       $("#" + fileField + "Download").hide();
                       $('#saveModal').modal('hide');
                       load();
               }});
           })("input-configfile", "configFile");
       
           $('#saveModal').modal('show');
           $('input[name=fileManageId]').val(fileManageId)
        });
        
    }});

    loadStype("commodityhouse.project.projectType","projectType");
    
    if(id){
         $.ajax({ url: url+"/selectByApplyId?id="+id, success: function(obj){
            $('input[name=id]').val(obj.id)
            $('input[name=projectNo]').val(obj.projectNo)
            $("#projectNo").val(obj.projectNo);
            $('input[name=projectName]').val(obj.projectName)
            $('input[name=projectType]').val(obj.projectType)
            $('input[name=projectFzr]').val(obj.projectFzr)
            $('input[name=projectGk]').val(obj.projectGk)
            $('input[name=lxdh]').val(obj.lxdh)
            $('input[name=lxr]').val(obj.lxr)
            $('input[name=projectXmzl]').val(obj.projectXmzl)
            loadStype("commodityhouse.project.projectType","projectType",obj.projectType);
            
            
            $.ajax({ url:"/house/configs/getMapConfigs?configPrefix=structure.", success: function(config){
                    var buildtable = $("#buildings");
                    buildtable.empty();
                    for (var i=0;i<obj.listBuilding.length;i++)
                    {
                        var rowData = obj.listBuilding[i];
                        var button = "";
                        if(rowData.siffFileid){
                            button = "<button type='button' onclick='openCad(\""+rowData.siffFileid + "\");' class='btn btn-info btn-xs'>预览</button>";
                        }
                        var rowData = obj.listBuilding[i];
                        var row = "<tr id><td hidden=>" + id +"</td>"
                                +"<td>" + rowData.projectNo + "</td><td>" + rowData.lpzh + "</td>"
                                +"<td>" + rowData.lpmc + "</td><td>" + rowData.ghyt + "</td>"
                                +"<td hidden=>" + rowData.fwlx + "</td><td>" + rowData.jznd + "</td>"
                                +"<td hidden=>" + rowData.wwjzmj + "</td><td hidden=>" + rowData.hsjzmj + "</td>"
                                +"<td>" + rowData.jzzmj + "</td><td>" + rowData.zts + "</td>"
                                +"<td>" + rowData.zcs + "</td><td>" + rowData.dscs + "</td>"
                                +"<td>" + rowData.dxcs + "</td><td>" + rowData.chlx + "</td>"
                                +"<td>" + (config[rowData.jzjg] == null?rowData.jzjg:config[rowData.jzjg]) + "</td>"
                                +"<td>" + button + "</td>";
                        buildtable.append(row);
                    }
            }});
            
           
            
            $('#saveBuildingModal').modal('hide');
        }}); 
         
         $.get(url + "/selectByHouses?id=" + id).done(function (data) {
             var config = {
                 id: "tg1",
                 width: "800",
                 renderTo: "div1",
                 headerAlign: "left",
                 headerHeight: "30",
                 dataAlign: "left",
                 indentation: "40",
                 folderColumnIndex: "1",
                 folderOpenIcon: "/img/folderOpen.gif",
                 folderCloseIcon: "/img/folderClose.gif",
                 defaultLeafIcon: "/img/defaultLeaf.gif",
                 itemClick: "itemClickEvent",
                 doubleClick: "",
                 expandLayer: 1,
                 columns:[
                     {headerText: "幢id", dataField: "buildNo", folderHidden:"true",  headerAlign: "center"},
                     {headerText: "房号", dataField: "houseNo", headerAlign: "center"},
                     {headerText: "楼(幢)号", dataField: "lpzh", headerAlign: "center"},
                     {headerText: "建筑结构", dataField: "buildStructure", folderHidden:"true", headerAlign: "center"},
                     {headerText: "总层数", dataField: "layersTotal", headerAlign: "center"},
                     {headerText: "所在层", dataField: "layersLocation", headerAlign: "center"},
                     {headerText: "名义层", dataField: "myc", headerAlign: "center"},
                     {headerText: "建筑面积", dataField: "buildArea", headerAlign: "center"},
                     {headerText: "套内建筑面积", dataField: "innerArea", headerAlign: "center"},
                     {headerText: "分摊建筑面积", dataField: "shareArea", headerAlign: "center"},
                     {headerText: "房屋规划", dataField: "planUse", headerAlign: "center"},
                 ],
                 data:data
             };

              //创建一个组件对象  
             var treeGrid = new TreeGrid(config);
             treeGrid.show();
         });
    }
    
};
var loadStype = function(configPrefix,table,aptitude) {
    $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefix, success: function(data){
        var tables = $("#" + table + "");
        tables.empty();
        $.each(data,function(index,obj){
            var arr = obj.value;
            var strs= new Array();
            strs = arr.split(",");
            for(var i=0;i<strs.length ;i++){
                var rowData = strs[i];
                if(aptitude == rowData){
                    tables.append("<option value='"+rowData+"' selected>" + rowData + "</option>");
                }else{
                    tables.append("<option value='"+rowData+"'>" + rowData + "</option>");
                }
            }
        });
    }});
};

var loadBuildNos = function(table,params) {
    var tables = $("#" + table + "");
    tables.empty();
    $("#buildings").find('tr').each(function(i,v){
        var lpzh = $(v).find("td:eq(2)").text();
        if(params == lpzh){
            tables.append("<option value='"+lpzh+"' selected>" + lpzh + "</option>");
        }else{
            tables.append("<option value='"+lpzh+"'>" + lpzh + "</option>");
        }
     });
};
/* 
function viewfile(fileId,fileType) {
    var configPrefixFileUrl = "house.file.url";
    var configPrefixServer = "house.file.serverurl";
    
    $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixServer, success: function(service){
        $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixFileUrl, success: function(downfile){
            var file = "http://" + downfile[0].value + "/open/files/"+fileId;
            var url = "http://" + service[0].value + "/onlinePreview?url=" + encodeURIComponent(file) + "&fileType=" + fileType;
            var winHeight = window.document.documentElement.clientHeight-10;
            window.open(url, "_blank", "height=" + winHeight
                    + ",top=80,left=80,toolbar=no, menubar=no, scrollbars=yes, resizable=yes"); 
        }});
    }});
}
 */
function isJSON(str) {
    if (typeof str == 'string') {
        try {
            var obj=JSON.parse(str);
            if(typeof obj == 'object' && obj ){
                return true;
            }else{
                return false;
            }

        } catch(e) {
            return false;
        }
    }
}
/* 
function viewJpgFile(fileIds, fileType) {
    var configPrefixFileUrl = "house.file.url";
    var configPrefixServer = "house.file.serverurl";
    
    $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixServer, success: function(service){
        $.ajax({ url:"/house/configs/systype?configPrefix=" + configPrefixFileUrl, success: function(downfile){
            var urls = '';
            $.each(fileIds, function(index, value){
                if(index === fileIds.length - 1){
                    urls += "http://" + downfile[0].value + "/open/files/" + value['fileId'];
                    
                    return true;
                }
                urls += "http://" + downfile[0].value + "/open/files/" + value['fileId'] + "|";
            });
            
            var url = "http://" + service[0].value + "/picturesPreview?urls=" + encodeURIComponent(urls) + "&currentUrl=http://localhost:9080";
            var winHeight = window.document.documentElement.clientHeight-10;
            window.open(url, "_blank", "height=" + winHeight
                    + ",top=80,left=80,toolbar=no, menubar=no, scrollbars=yes, resizable=yes"); 
        }});
    }});
}
 */
function openCad(fileId){
    layer.open({
      type: 2, //Layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）,
      shade:0.1, //遮罩层透明度
      area:['100%','100%'], //弹出层宽高
      title:'CAD图查看',//弹出层标题
      content: ['cad.html?fileid='+fileId, 'no']
    });
}

function downloadCad(fileId){
	if(fileId){
		self.location.href="/open/files/"+fileId;
	}
}

load();
</script>
</body>
</html>